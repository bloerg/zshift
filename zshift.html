<!DOCTYPE html lang="de-DE">
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>zshift</title>
    
    <script src="./fits.js" type="text/javascript" charset="utf-8"></script>
    <script src="./jquery-1.11.3.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="./jquery-ui/jquery-ui.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="./jquery.flot.js" type="text/javascript" charset="utf-8"></script>
    <script src="./bootstrap/js/bootstrap.min.js"></script>
    <script src="./dygraph-combined.js"></script>
<!--
    <script src="./markedLines.js"></script>
-->
    
    <link rel="stylesheet" href="./jquery-ui/jquery-ui.min.css">
    <link rel="stylesheet" href="./bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="./bootstrap/css/bootstrap-theme.min.css">


<!--
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">


<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
-->

</head>
<body>


    <nav class="navbar navbar-default navbar-static-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">zshift</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="#">Home</a></li>
            <li><a href="#about">About</a></li>
            <li><a href="mailto:dev@bloerg.de">Contact</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>
    




    <div class="container-fluid">
        <div class="row-fluid">
          <div class="col-md-10 col-md-offset-1">


            <div style="width:100%;height:500px;text-align:left;margin:10px auto;" id="spectrum"></div>

            
             <div class="row-fluid" style="display:none">
                    <div class="span12">
                        <p class="text-center">Press and hold SHIFT key to pan right, left, up, or down. <button class="btn" type="button" onclick="unzoomGraph(window.g);">Unzoom</button></p>
                        <p class="text-center">
                            <label class="checkbox inline"><input type="checkbox" id="best_fit" onclick="change(this,window.g);" checked="checked" />Best Fit</label>
                            <label class="checkbox inline"><input type="checkbox" id="sky_flux" onclick="change(this,window.g);" />Sky Flux</label>
                            <label class="checkbox inline"><input type="checkbox" id="emissLines" onclick="window.g.updateOptions({});" checked="checked" />Mark Emission Lines</label>
                            <label class="checkbox inline"><input type="checkbox" id="absorpLines" onclick="window.g.updateOptions({});" checked="checked" />Mark Absorption Lines</label>
                            <label class="checkbox inline"><input type="checkbox" id="stepPlot" onclick="change(this,window.g);" checked="checked" />Plot Flux in Steps</label>
                        </p>
                    </div>
                </div>

<!-- slider -->
            <div class="row-fluid">
                <div class="col-md-10">
                    <div id="red_shift_slider" style="margin-top: 10px"></div>
                </div>
                <div class="col-md-2">
                    <div class="input-group">
                        <input id="red_shift_input" type="text" class="form-control" placeholder="redshift">
                        <span class="input-group-btn">
                            <button id="button_set_redshift" class="btn btn-default" type="button">Set!</button>
                        </span>
                    </div>
                </div>
            </div>
            <div class="row-fluid">
                <div class="col-md-10">
                    <p class="text-center">redshift</p>
                </div>
                <div class="col-md-2"></div>
            </div>
<!-- /slider -->

        </div>

<!-- spec lines -->
<!--
        <div class="col-md-2">
        
        </div>
-->
<!-- /spec lines -->

        </div>
    </div> <!-- /container -->

</body>


<script type="text/javascript">

$(function() {
    
    var redshift = {
        value: 1,
        set: function() {
            this.value = $("#red_shift_slider").slider("value") / 100;
            $("#red_shift_input").val(this.value);
        },
        get: function () {
            return this.value;
        }
    }
    
    var g = new Dygraph(
        document.getElementById("spectrum"),
        "./spectrum.csv",
        { // Options for Dygraph
            visibility : [true, true, false],
            title: 'Plate: 1251, MJD: 52964, Fiber: 0194',
            xlabel: 'Wavelength [Ångströms]',
            ylabel: 'Flux [10<sup>-17</sup> erg/cm<sup>2</sup>/s/Å]',
            stepPlot: true,
            colors: ['#000000', '#EE1111', "#AE00DB"],
            underlayCallback: underlaycallback_helper,
        }
    );
    
    $( "#red_shift_slider" ).slider({
        create: function() {redshift.set()},
        orientation: "horizontal",
        range: false,
        min: 0,
        max: 1000,
        value: 100,
        slide: function() {
            //g.updateOptions({underlayCallback: underlaycallback_helper})
            redshift.set();
            $("#red_shift_input").val(redshift.get());
            g.updateOptions({})

        },
        change: function() {
            //g.updateOptions({underlayCallback: underlaycallback_helper})
            redshift.set();
        }
    });
    
    $("#button_set_redshift").click( function() {
        $("#red_shift_slider").slider( "option", "value", $("#red_shift_input").val() * 100);
    });
    
    //
    // This file is used by spectrumDetail.html
    //
    var lines = [
        //
        // This is the set of emission lines from the spZline files.
        // See $IDLSPEC2D_DIR/etc/emlines.par
        // Wavelengths are in air for lambda > 2000, vacuum for lambda < 2000.
        //
        {"name" : "Ly-α",           "lambda" : 1215.67,  "emission" : true },
        {"name" : "N V 1240",       "lambda" : 1240.81,  "emission" : true },
        {"name" : "C IV 1549",      "lambda" : 1549.48,  "emission" : true },
        {"name" : "He II 1640",     "lambda" : 1640.42,  "emission" : true },
        {"name" : "C III] 1908",    "lambda" : 1908.734, "emission" : true },
        {"name" : "Mg II 2799",     "lambda" : 2799.49,  "emission" : true },
        {"name" : "[O II] 3725",    "lambda" : 3726.032, "emission" : true },
        {"name" : "[O II] 3727",    "lambda" : 3728.815, "emission" : true },
        {"name" : "[Ne III] 3868",  "lambda" : 3868.76,  "emission" : true },
        {"name" : "Hε",             "lambda" : 3889.049, "emission" : true },
        {"name" : "[Ne III] 3970",  "lambda" : 3970.00,  "emission" : true },
        {"name" : "Hδ",             "lambda" : 4101.734, "emission" : true },
        {"name" : "Hγ",             "lambda" : 4340.464, "emission" : true },
        {"name" : "[O III] 4363",   "lambda" : 4363.209, "emission" : true },
        {"name" : "He II 4685",     "lambda" : 4685.68,  "emission" : true },
        {"name" : "Hβ",             "lambda" : 4861.325, "emission" : true },
        {"name" : "[O III] 4959",   "lambda" : 4958.911, "emission" : true },
        {"name" : "[O III] 5007",   "lambda" : 5006.843, "emission" : true },
        {"name" : "He II 5411",     "lambda" : 5411.52,  "emission" : true },
        {"name" : "[O I] 5577",     "lambda" : 5577.339, "emission" : true },
        {"name" : "[N II] 5755",    "lambda" : 5754.59,  "emission" : true },
        {"name" : "He I 5876",      "lambda" : 5875.68,  "emission" : true },
        {"name" : "[O I] 6300",     "lambda" : 6300.304, "emission" : true },
        {"name" : "[S III] 6312",   "lambda" : 6312.06,  "emission" : true },
        {"name" : "[O I] 6363",     "lambda" : 6363.776, "emission" : true },
        {"name" : "[N II] 6548",    "lambda" : 6548.05,  "emission" : true },
        {"name" : "Hα",             "lambda" : 6562.801, "emission" : true },
        {"name" : "[N II] 6583",    "lambda" : 6583.45,  "emission" : true },
        {"name" : "[S II] 6716",    "lambda" : 6716.44,  "emission" : true },
        {"name" : "[S II] 6730",    "lambda" : 6730.82,  "emission" : true },
        {"name" : "[Ar III] 7135",  "lambda" : 7135.790, "emission" : true },
        //
        // Absorption lines
        //
        {"name" : "Hε",             "lambda" : 3889.049, "emission" : false },
        {"name" : "K (Ca II 3933)", "lambda" : 3933.7,   "emission" : false },
        {"name" : "H (Ca II 3968)", "lambda" : 3968.5,   "emission" : false },
        {"name" : "Hδ",             "lambda" : 4101.734, "emission" : false },
        {"name" : "G (Ca I 4307)",  "lambda" : 4307.74,  "emission" : false },
        {"name" : "Hγ",             "lambda" : 4340.464, "emission" : false },
        {"name" : "Hβ",             "lambda" : 4861.325, "emission" : false },
        {"name" : "Mg I 5175",      "lambda" : 5175.0,   "emission" : false },
        {"name" : "D2 (Na I 5889)", "lambda" : 5889.95,  "emission" : false },
        //{"name" : "D (Na I doublet)","lambda": 5892.9,   "emission" : false },
        {"name" : "D1 (Na I 5895)", "lambda" : 5895.92,  "emission" : false },
        {"name" : "Hα",             "lambda" : 6562.801, "emission" : false },
        ];
    //
    // Turns spectral lines on and off.
    //
    function change(el,g) {
        if (el.id == "stepPlot") {
            g.updateOptions( { stepPlot: el.checked } );
        } else {
            g.setVisibility(((el.id == "best_fit") ? 1 : 2), el.checked);
        }
    }
    //
    // Powers the "Unzoom" button.
    //
    function unzoomGraph(g) {
        g.updateOptions({ dateWindow: null, valueRange: null });
    }
    //
    // Used to zoom in on emission lines.
    //
    function zoomGraphX(minDate, maxDate, g) {
        g.updateOptions({ dateWindow: [minDate, maxDate] });
    }
    //
    // Helper function used by underlaycallback.
    //
    function getLeftRight(centerWave,g) {
        var center = g.toDomCoords(centerWave, 0);
        return [center[0] - 2, center[0] + 2];
    }
    //
    // Convert to vacuum wavelength.
    //
    function airtovac(lambda) {
        //
        // Don't convert less than 2000.
        //
        if (lambda < 2000.0) return lambda;
        var lambda_vac = lambda;
        for ( var iter = 0; iter < 2; iter++ ) {
            var sigma2 = (1.0e4/lambda_vac)*(1.0e4/lambda_vac);
            var fact = 1.0 + 5.792105e-2/(238.0185 - sigma2) + 1.67917e-3/(57.362 - sigma2);
            lambda_vac = lambda*fact;
        }
        return lambda_vac;
    }
    //
    // This function draws the spectra line markers.
    //
    function underlaycallback(canvas, area, g, redshift) {
        //var echecked = document.getElementById("emissLines").checked;
        //var achecked = document.getElementById("absorpLines").checked;
        echecked = true;
        achecked = true;
        if (echecked || achecked) {
            for (var i = 0; i < lines.length; i++) {
                if (lines[i].emission && !echecked) continue;
                if (!lines[i].emission && !achecked) continue;
                var shiftedWave = airtovac(lines[i].lambda)* redshift.get();
                var leftright = getLeftRight(shiftedWave,g);
                canvas.fillStyle = lines[i].emission ? "rgba(0, 38, 220, 0.2)" : "rgba(220, 0, 5, 0.2)";
                canvas.fillRect(leftright[0], area.y, leftright[1] - leftright[0], area.h);
                canvas.font = "15px sans-serif";
                canvas.fillStyle = lines[i].emission ? "rgba(0, 38, 220, 1)" : "rgba(220, 0, 5, 1)";
                var offset = (i%3)*15 + 20;
                var texty = lines[i].emission ? area.y + offset : area.y+area.h - offset;
                canvas.fillText(lines[i].name,leftright[0],texty);
            }
        }
    }


    function underlaycallback_helper(canvas, area, g) {
        underlaycallback(canvas, area, g, redshift)
    }


    
    console.log(redshift.get());
    
    var FITS = astro.FITS;
    


    var plot_fits = function(fitsobject, arguments) {
        
        //COEFF0, COEFF1, needed for computation of wavelenghts in older spSpec files
        //see: http://classic.sdss.org/dr3/products/spectra/read_spSpec.html
        var hdu = this.getHDU(0);
        //console.log("hdu0", hdu);
        var coeff0 = hdu.header.cards.COEFF0.value;
        var coeff1 = hdu.header.cards.COEFF1.value;
        
        // Get the dataunit object for spectrum
        // see http://data.sdss3.org/datamodel/files/BOSS_SPECTRO_REDUX/RUN2D/spectra/PLATE4/spec.html
        var dataunit = this.getDataUnit();
        var spec_width=dataunit.rows; 
        
        var dataview = new DataView(dataunit.buffer, 0); //see: http://www.javascripture.com/DataView
        var element_byteLength=4;
        var spectrum_field = 0;
        var wavelength_field = 1;
        var spectrum=[];
        for (i = 0; i<dataview.byteLength; i+=element_byteLength*8) {
            //console.log("float", i, dataview.getFloat32(i))
            //console.log("int", i, dataview.getInt32(i))
            spectrum.push([Math.pow(10,dataview.getFloat32(i+wavelength_field * element_byteLength)), dataview.getFloat32(i + spectrum_field * element_byteLength)])
        }


        
        //~ var g = new Dygraph(
            //~ document.getElementById("spectrum"),
            //~ spectrum,
            //~ { // Options for Dygraph
                //~ visibility : [true, true, false],
                //~ title: 'Plate: 1251, MJD: 52964, Fiber: 0194',
                //~ xlabel: 'Wavelength [Ångströms]',
                //~ ylabel: 'Flux [10<sup>-17</sup> erg/cm<sup>2</sup>/s/Å]',
                //~ stepPlot: true,
                //~ colors: ['#000000', '#EE1111', "#AE00DB"],
                //~ underlayCallback: underlaycallback_helper,
            //~ }
        //~ );

        
    }   
    // Set path to FITS file
    //var url = "./spSpec-53177-1572-467.fit";
    var url = "./spec-1251-52964-0194.fits";
    // Initialize a new FITS File object

    var fits = new FITS(url, plot_fits, "astring");
    console.log(fits);

    //~ console.log(fits);
    // Alternatively, the FITS object may be initialized using the HTML File API.
    //var fits = new FITS.File(fileObj, plot_fits);

    



});

</script>
</html>
